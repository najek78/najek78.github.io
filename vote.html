<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Głosowanie</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  background: radial-gradient(circle at center,#0b1b3a,#020817);
  color:#D3AF37;
  font-family:'Cinzel',serif;
  display:flex;
  flex-direction:column;
  align-items:center;
}

h1{
  margin-top:20px;
  letter-spacing:4px;
}


.nominees-row{
  display:flex;
  gap:18px;
  margin-top:20px;
}

.nominee-card{
  width:300px;
  background:rgba(255,215,0,0.08);
  border:2px solid #D3AF37;
  border-radius:18px;
  padding:12px;
  text-align:center;
  box-shadow:0 0 18px rgba(255,215,0,0.25);
}

.nominee-avatar{
  width:80px;
  border-radius:50%;
  border:3px solid #D3AF37;
}

.video-frame{
  border:2px solid #D3AF37;
  border-radius:12px;
  overflow:hidden;
}

.video-frame iframe{
  width:300px;
  height:158px;
}


.ranking-row{
  display:flex;
  gap:34px;
  margin-top:35px;
}

.rank-slot{
  width:120px;
  text-align:center;
}

.dropzone{
  margin-top:10px;
  height:90px;
  border:2px dashed #D3AF37;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.rank-avatar{
  width:70px;
  border-radius:50%;
  border:3px solid #D3AF37;
}

.locked{
  border-color:#888;
  opacity:0.6;
}


.drag-avatars{
  display:flex;
  gap:22px;
  margin-top:25px;
}

.drag-avatar{
  width:70px;
  border-radius:50%;
  border:3px solid #D3AF37;
  cursor:grab;
}

.drag-avatar.used{
  filter:grayscale(1);
  opacity:0.35;
  cursor:not-allowed;
}


.buttons-row{
  display:flex;
  gap:20px;
  margin-top:30px;
}

button{
  background:#D3AF37;
  color:#0b1b3a;
  border:none;
  padding:14px 36px;
  border-radius:12px;
  font-weight:bold;
  cursor:pointer;
}

button:disabled{
  background:#555;
  cursor:not-allowed;
}
</style>
</head>

<body>

<h1>GŁOSOWANIE</h1>

<div id="nominees" class="nominees-row"></div>
<div id="ranking" class="ranking-row"></div>

<h2>UŁÓŻ KOLEJNOŚĆ</h2>
<div id="dragAvatars" class="drag-avatars"></div>

<div class="buttons-row">
  <button id="voteBtn" onclick="submitVote()" disabled>Zagłosuj</button>
  <button onclick="resetRanking()">Resetuj</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const { createClient } = supabase;

const supabaseClient = createClient(
  "https://vxbdvwjxudlxybnfsugn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4YmR2d2p4dWRseHlibmZzdWduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExODQyODEsImV4cCI6MjA4Njc2MDI4MX0.ZJG2DTwhcj8nG9eyUN1B3Zuf2IFIIZcq1rYpsYptrBk"
);

const params = new URLSearchParams(window.location.search);
const categoryId = params.get("category");

let nomineesList = [];
let selected = {};
let selfNominee = null;


async function loadNominees(){

  const { data } = await supabaseClient
    .from("nominees")
    .select("*")
    .eq("category_id", categoryId);

  nomineesList = data;

  const { data:{user} } = await supabaseClient.auth.getUser();
  selfNominee = nomineesList.find(n => n.user_id === user.id);

  renderNominees();
  renderDragAvatars();
  createRanking();
}

loadNominees();


function renderNominees(){
  const container = document.getElementById("nominees");
  container.innerHTML="";

  nomineesList.forEach(n=>{
    container.innerHTML += `
      <div class="nominee-card">
        <h3>${n.name}</h3>
        <img src="${n.avatar_url}" class="nominee-avatar">
        <div class="video-frame">
          <iframe src="${n.video_url}" frameborder="0" allowfullscreen></iframe>
        </div>
      </div>
    `;
  });
}


function renderDragAvatars(){
  const dragContainer = document.getElementById("dragAvatars");
  dragContainer.innerHTML="";

  nomineesList.forEach(n=>{

    const isSelf = selfNominee && n.id === selfNominee.id;

    dragContainer.innerHTML += `
      <img src="${n.avatar_url}"
           class="drag-avatar ${isSelf ? 'used' : ''}"
           draggable="${isSelf ? 'false' : 'true'}"
           data-id="${n.id}"
           ondragstart="drag(event)">
    `;
  });
}


function createRanking(){
  const container = document.getElementById("ranking");

  for(let i=1;i<=5;i++){

    const slot = document.createElement("div");
    slot.className="rank-slot";

    const zone = document.createElement("div");
    zone.className="dropzone";
    zone.id="rank"+i;
    zone.ondragover = e => e.preventDefault();
    zone.ondrop = drop;

    if(i===5 && selfNominee){
      zone.classList.add("locked");
      zone.innerHTML = `<img src="${selfNominee.avatar_url}" class="rank-avatar">`;
      zone.dataset.value = selfNominee.id;
      selected[zone.id] = selfNominee.id;
    }

    slot.innerHTML = `Miejsce ${i}`;
    slot.appendChild(zone);
    container.appendChild(slot);
  }
}


function drag(ev){
  ev.dataTransfer.setData("text", ev.target.dataset.id);
}


function drop(ev){
  ev.preventDefault();

  const id = ev.dataTransfer.getData("text");
  const zone = ev.currentTarget;

  if(zone.classList.contains("locked")) return;

  if(Object.values(selected).includes(id)){
    alert("Ten nominowany jest już użyty!");
    return;
  }

  const nominee = nomineesList.find(n => n.id == id);

  zone.innerHTML = `<img src="${nominee.avatar_url}" class="rank-avatar">`;
  zone.dataset.value = id;
  selected[zone.id] = id;

  markUsed();
  checkCompletion();
}


function markUsed(){

  document.querySelectorAll(".drag-avatar").forEach(a=>{
    const id = a.dataset.id;

    
    if(selfNominee && id == selfNominee.id){
      a.classList.add("used");
      a.draggable = false;
      return;
    }

    
    if(Object.values(selected).includes(id)){
      a.classList.add("used");
      a.draggable = false;
    }else{
      a.classList.remove("used");
      a.draggable = true;
    }
  });
}


function checkCompletion(){

  const filled = ["rank1","rank2","rank3","rank4","rank5"]
    .every(id => document.getElementById(id).dataset.value);

  document.getElementById("voteBtn").disabled = !filled;
}


function resetRanking(){

  selected = {};

  document.querySelectorAll(".dropzone").forEach(zone=>{

    
    if(zone.id === "rank5" && selfNominee){
      zone.innerHTML = `<img src="${selfNominee.avatar_url}" class="rank-avatar">`;
      zone.dataset.value = selfNominee.id;
      selected[zone.id] = selfNominee.id;
      return;
    }

    if(zone.classList.contains("locked")) return;

    zone.innerHTML="";
    zone.dataset.value="";
  });

  markUsed();
  checkCompletion();
}


async function submitVote(){

  const { data:{user} } = await supabaseClient.auth.getUser();

  await supabaseClient.from("votes").insert({
    user_id:user.id,
    category_id:categoryId,
    rank1:rank1.dataset.value,
    rank2:rank2.dataset.value,
    rank3:rank3.dataset.value,
    rank4:rank4.dataset.value,
    rank5:rank5.dataset.value
  });

  alert("Głos zapisany!");
  window.location.href="categories.html";
}
</script>

</body>
</html>

